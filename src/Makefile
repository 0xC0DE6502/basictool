# A hopefully simple, portable makefile, based on reading
# https://nullprogram.com/blog/2017/08/20/.

.POSIX:
.SUFFIXES:
# TODO: Enable optimisation?
CC	= cc # TODO!?
CFLAGS  = -g -Wall --std=c99
LDFLAGS = -g
EDITORA = ../roms/EDITORA100.rom
EDITORB = ../roms/EDITORB100.rom
BASIC   = ../roms/basic4.rom

all: ../basictool

BASICTOOLOBJS  = main.o config.o other.o data.o utils.o lib6502.o cargs.o
../basictool: $(BASICTOOLOBJS)
	$(CC) $(LDFLAGS) -o $@ $(BASICTOOLOBJS)

rom-editor-a.c: bintoinc $(EDITORA)
	./bintoinc $(EDITORA) > rom-editor-a.c

rom-editor-b.c: bintoinc $(EDITORB)
	./bintoinc $(EDITORB) > rom-editor-b.c

rom-basic.c: bintoinc $(BASIC)
	./bintoinc $(BASIC) > rom-basic.c

BINTOINCOBJS = bintoinc.o
bintoinc: $(BINTOINCOBJS)
	$(CC) $(LDFLAGS) -o $@ $(BINTOINCOBJS)

clean:
	# TODO: Make sure this includes everything
	# TODO: Rename the auto-generated files zz-*? I'd feel happier deleting them then
	rm -f ../basictool bintoinc depend.txt *.o # TODO: rom-*.c

depend:
	# This is just a convenience for generating the dependencies, which
	# then need to be manually copied into this Makefile. I'm trying to
	# keep things simple and portable, and this isn't a huge project.
	for FILE in *.c; do gcc -MM $$FILE; done > depend.txt

.SUFFIXES: .c .o
.c.o:
	$(CC) $(CFLAGS) -c $<

# Manually included copy of depend.txt generated by "make depend".
# TODO: Keep this up to date!
bintoinc.o: bintoinc.c
cargs.o: cargs.c cargs.h
config.o: config.c config.h
data.o: data.c data.h rom-editor-a.c rom-editor-b.c rom-basic.c
foo.o: foo.c cargs.h
lib6502.o: lib6502.c lib6502.h
main.o: main.c cargs.h config.h data.h utils.h
other.o: other.c config.h data.h lib6502.h utils.h
rom-basic.o: rom-basic.c
rom-editor-a.o: rom-editor-a.c
rom-editor-b.o: rom-editor-b.c
utils.o: utils.c utils.h
