# A hopefully simple, portable makefile, based on reading
# https://nullprogram.com/blog/2017/08/20/.

.POSIX:
.SUFFIXES:
CFLAGS  = -g -O2 -Wall -Werror --std=c99
LDFLAGS = -g
EDITORA = ../roms/EDITORA100.rom
EDITORB = ../roms/EDITORB100.rom
BASIC   = ../roms/basic4.rom

all: ../basictool

BASICTOOLOBJS  = main.o config.o emulation.o driver.o roms.o utils.o lib6502.o cargs.o
../basictool: $(BASICTOOLOBJS)
	$(CC) $(LDFLAGS) -o $@ $(BASICTOOLOBJS)

zz-editor-a.c: bintoinc $(EDITORA)
	./bintoinc $(EDITORA) > zz-editor-a.c

zz-editor-b.c: bintoinc $(EDITORB)
	./bintoinc $(EDITORB) > zz-editor-b.c

zz-basic.c: bintoinc $(BASIC)
	./bintoinc $(BASIC) > zz-basic.c

BINTOINCOBJS = bintoinc.o
bintoinc: $(BINTOINCOBJS)
	$(CC) $(LDFLAGS) -o $@ $(BINTOINCOBJS)

clean:
	# TODO: Make sure this includes everything
	rm -f ../basictool bintoinc depend.txt *.o zz-*.c

depend: zz-editor-a.c zz-editor-b.c zz-basic.c
	# This is just a convenience for generating the dependencies, which
	# then need to be manually copied into this Makefile. I'm trying to
	# keep things simple and portable, and this isn't a huge project.
	for FILE in *.c; do gcc -MM $$FILE; done > depend.txt

.SUFFIXES: .c .o
.c.o:
	$(CC) $(CFLAGS) -c $<

# Manually included copy of depend.txt generated by "make depend".
# TODO: Keep this up to date!
bintoinc.o: bintoinc.c
cargs.o: cargs.c cargs.h
config.o: config.c config.h
driver.o: driver.c cargs.h config.h emulation.h lib6502.h main.h utils.h
emulation.o: emulation.c emulation.h lib6502.h driver.h roms.h utils.h
lib6502.o: lib6502.c lib6502.h
main.o: main.c main.h cargs.h config.h driver.h emulation.h lib6502.h \
 roms.h utils.h
roms.o: roms.c roms.h zz-editor-a.c zz-editor-b.c zz-basic.c
utils.o: utils.c utils.h main.h
zz-basic.o: zz-basic.c
zz-editor-a.o: zz-editor-a.c
zz-editor-b.o: zz-editor-b.c
